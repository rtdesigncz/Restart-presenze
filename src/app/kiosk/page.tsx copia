// src/app/kiosk/page.tsx
"use client";

import React, { useEffect, useMemo, useRef, useState } from "react";
import Image from "next/image";
import { supabase } from "@/lib/supabaseClient";
import { useToast } from "@/components/ToastProvider";

type Istruttore = { id: string; full_name: string; has_pin: boolean };
type Prefs = { last_sala: string | null; recent_corsi: string[] | null };

const SALE = ["SALA A", "SALA A+B", "SALA B", "SALA C", "SALA B+C"];
const KIOSK_IDLE_SECONDS = 60; // timeout inattività

function fmtHumanDate(iso: string) {
  const [y, m, d] = iso.split("-").map(Number);
  const date = new Date(y, (m || 1) - 1, d || 1);
  const fmt = new Intl.DateTimeFormat("it-IT", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
  });
  const s = fmt.format(date);
  return s.charAt(0).toUpperCase() + s.slice(1);
}
function addDaysISO(iso: string, delta: number) {
  const [y, m, d] = iso.split("-").map(Number);
  const date = new Date(y, (m || 1) - 1, d || 1);
  date.setDate(date.getDate() + delta);
  return [
    String(date.getFullYear()),
    String(date.getMonth() + 1).padStart(2, "0"),
    String(date.getDate()).padStart(2, "0"),
  ].join("-");
}
function nowHM(): string {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(Math.floor(d.getMinutes() / 30) * 30).padStart(2, "0"); // arrotonda a 30'
  return `${hh}:${mm}`;
}
function plusMinutes(hm: string, minutes: number): string {
  const [h, m] = hm.split(":").map(Number);
  const total = h * 60 + m + minutes;
  const dayMin = ((total % (24 * 60)) + 24 * 60) % (24 * 60);
  const hh = Math.floor(dayMin / 60);
  const mm = dayMin % 60;
  return `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
}

export default function KioskPage() {
  const toast = useToast();

  const [view, setView] = useState<"list" | "pin" | "form">("list");
  const [search, setSearch] = useState("");
  const [istruttori, setIstruttori] = useState<Istruttore[]>([]);
  const [selected, setSelected] = useState<Istruttore | null>(null);
  const [pin, setPin] = useState("");
  const [pinError, setPinError] = useState<string | null>(null);

  const [giorno, setGiorno] = useState<string>(() => new Date().toISOString().slice(0, 10));
  const dateInputRef = useRef<HTMLInputElement>(null);

  // form
  const [sala, setSala] = useState<string>(SALE[0]);
  const [dalle, setDalle] = useState<string>(nowHM());
  const [alle, setAlle] = useState<string>(plusMinutes(nowHM(), 60));
  const [corso, setCorso] = useState("");
  const [sostituzione, setSostituzione] = useState(false);
  const [note, setNote] = useState("");
  const [prefs, setPrefs] = useState<Prefs>({ last_sala: null, recent_corsi: [] });

  // === IDLE SESSION ===
  const idleTimer = useRef<NodeJS.Timeout | null>(null);
  const [idleLeft, setIdleLeft] = useState<number>(KIOSK_IDLE_SECONDS);
  const idleTick = useRef<NodeJS.Timeout | null>(null);

  const clearIdle = () => {
    if (idleTimer.current) clearTimeout(idleTimer.current);
    if (idleTick.current) clearInterval(idleTick.current);
    idleTimer.current = null;
    idleTick.current = null;
  };

  const resetToList = () => {
    setView("list");
    setSelected(null);
    setPin("");
    setPinError(null);
    setIdleLeft(KIOSK_IDLE_SECONDS);
    clearIdle();
  };

  const bumpIdle = () => {
    if (view === "list") return; // lista non ha sessione PIN
    // reset timer e countdown
    if (idleTimer.current) clearTimeout(idleTimer.current);
    if (!idleTick.current) {
      idleTick.current = setInterval(() => {
        setIdleLeft((s) => (s > 0 ? s - 1 : 0));
      }, 1000);
    }
    setIdleLeft(KIOSK_IDLE_SECONDS);
    idleTimer.current = setTimeout(() => {
      resetToList();
    }, KIOSK_IDLE_SECONDS * 1000);
  };

  // Eventi che resettano il timer quando NON siamo in lista
  useEffect(() => {
    if (view === "list") {
      clearIdle();
      setIdleLeft(KIOSK_IDLE_SECONDS);
      return;
    }

    const handler = () => bumpIdle();
    const handlerVisibility = () => {
      if (document.visibilityState === "visible") bumpIdle();
    };

    // eventi ampi (tablet-friendly)
    window.addEventListener("click", handler, { passive: true });
    window.addEventListener("keydown", handler);
    window.addEventListener("touchstart", handler, { passive: true });
    window.addEventListener("pointerdown", handler, { passive: true });

    // throttled mousemove
    let mmLock = false;
    const onMove = () => {
      if (mmLock) return;
      mmLock = true;
      bumpIdle();
      setTimeout(() => (mmLock = false), 1000);
    };
    window.addEventListener("mousemove", onMove, { passive: true });

    document.addEventListener("visibilitychange", handlerVisibility);

    // avvio immediato
    bumpIdle();

    return () => {
      window.removeEventListener("click", handler as any);
      window.removeEventListener("keydown", handler as any);
      window.removeEventListener("touchstart", handler as any);
      window.removeEventListener("pointerdown", handler as any);
      window.removeEventListener("mousemove", onMove as any);
      document.removeEventListener("visibilitychange", handlerVisibility as any);
      clearIdle();
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [view]);

  // Carica lista istruttori
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase.rpc("list_istruttori_public");
      if (!error && Array.isArray(data)) setIstruttori(data as Istruttore[]);
    })();
  }, []);

  const filtered = useMemo(() => {
    const term = search.trim().toLowerCase();
    if (!term) return istruttori;
    return istruttori.filter((i) => i.full_name.toLowerCase().includes(term));
  }, [istruttori, search]);

  const openDatePicker = () => {
    const el = dateInputRef.current;
    // @ts-ignore
    if (el?.showPicker) el.showPicker();
    else el?.click();
  };

  const selectIstruttore = (it: Istruttore) => {
    setSelected(it);
    setPin("");
    setPinError(null);
    setView("pin");
  };

  const loadPrefsAndGoForm = async () => {
    if (!selected) return;
    const { data: pr, error } = await supabase.rpc("recent_prefs", { p_user: selected.id });
    if (error) {
      setPinError("Errore di verifica. Riprova.");
      return;
    }
    const p = (pr as any) || {};
    setPrefs({ last_sala: p.last_sala ?? null, recent_corsi: p.recent_corsi ?? [] });
    if (p.last_sala && SALE.includes(p.last_sala)) setSala(p.last_sala);
    else setSala(SALE[0]);
    const n = nowHM();
    setDalle(n);
    setAlle(plusMinutes(n, 60));
    setCorso("");
    setSostituzione(false);
    setNote("");
    setView("form");
  };

  const verifyPinAndLoad = async () => {
    if (!selected) return;
    if (!pin || pin.length < 4) {
      setPinError("Inserisci il PIN (almeno 4 cifre).");
      return;
    }
    // Verifica PIN lato server (RPC tua che controlla hash)
    const { data: ok, error } = await supabase.rpc("verify_pin", {
      p_user: selected.id,
      p_pin: pin,
    });
    if (error || !ok) {
      setPinError("PIN non valido.");
      return;
    }
    await loadPrefsAndGoForm();
  };

  const submit = async () => {
    if (!selected) return;
    if (alle <= dalle) {
      toast.push("Orario non valido: l'ora di fine deve essere successiva a quella di inizio.", "error");
      return;
    }
    const { error } = await supabase.rpc("add_ora_kiosk", {
      p_user: selected.id,
      p_pin: pin,
      p_giorno: giorno,
      p_ora_start: dalle,
      p_ora_end: alle,
      p_sala: sala,
      p_corso: corso,
      p_sostituzione: sostituzione,
      p_note: note || null,
    });
    if (error) {
      toast.push(error.message || "Operazione non consentita.", "error");
      return;
    }
    toast.push("Ora inviata (in attesa di approvazione).", "success");
    // Rimani nel form per inserimenti successivi
    const n = nowHM();
    setDalle(n);
    setAlle(plusMinutes(n, 60));
    setCorso("");
    setSostituzione(false);
    setNote("");
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col">
      {/* Header Kiosk con logo e countdown */}
      <header className="bg-white border-b">
        <div className="max-w-[1200px] mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Image
              src="/logo-restart.png"
              alt="Restart"
              width={140}
              height={140}
              className="rounded"
              priority
            />
            <div>
              <div className="text-lg font-semibold leading-tight">Modalità Kiosk</div>
              <div className="text-xs text-slate-500">Inserimento rapido ore</div>
            </div>
          </div>

          {view !== "list" ? (
            <div className="flex items-center gap-3">
              <div className="hidden sm:flex items-center gap-2 text-sm text-slate-700">
                Ciao, <span className="font-medium">{selected?.full_name}</span>
              </div>
              {/* Countdown inattività */}
              <span className="tag">
                Auto-logout {idleLeft}s
              </span>
              <button
                className="btn btn-ghost"
                onClick={resetToList}
              >
                Cambia utente
              </button>
            </div>
          ) : (
            <div className="text-xs text-slate-500">Tablet condiviso</div>
          )}
        </div>
      </header>

      {/* Contenuti */}
      <main className="flex-1">
        {view === "list" && (
          <div className="max-w-3xl mx-auto px-4 py-6">
            <h1 className="text-2xl font-semibold mb-4 text-center">Seleziona Istruttore</h1>
            <div className="mb-4">
              <input
                className="input w-full h-11"
                placeholder="Cerca istruttore..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />
            </div>

            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
              {filtered.map((it) => (
                <button
                  key={it.id}
                  onClick={() => selectIstruttore(it)}
                  className="h-20 rounded-xl border bg-white shadow-sm active:scale-[.99] px-3 text-left"
                >
                  <div className="font-medium">{it.full_name}</div>
                  <div className="text-xs text-slate-500 mt-1">
                    {it.has_pin ? "PIN attivo" : "PIN mancante"}
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}

        {view === "pin" && (
          <div className="max-w-md mx-auto px-4 py-6">
            <div className="card p-5 border-slate-200">
              <div className="text-lg font-semibold mb-1">{selected?.full_name}</div>
              <div className="text-sm text-slate-500 mb-4">Inserisci il tuo PIN a 4 cifre</div>

              <div className="grid grid-cols-3 gap-3 mb-4">
                {[1,2,3,4,5,6,7,8,9,"←",0,"OK"].map((k, idx) => (
                  <button
                    key={idx}
                    className="h-14 rounded-xl border bg-white text-lg font-semibold"
                    onClick={() => {
                      if (k === "←") setPin((p) => p.slice(0, -1));
                      else if (k === "OK") verifyPinAndLoad();
                      else setPin((p) => (p + String(k)).slice(0, 6));
                      setPinError(null);
                      bumpIdle();
                    }}
                  >
                    {typeof k === "number" ? k : k}
                  </button>
                ))}
              </div>

              <div className="text-center text-2xl tracking-[.3em] mb-3">
                {pin.replace(/./g, "•")}
              </div>
              {pinError && <div className="text-sm text-red-600 mb-3">{pinError}</div>}

              <div className="flex justify-center">
                <button className="btn btn-brand w-full" onClick={() => { verifyPinAndLoad(); }}>
                  Continua
                </button>
              </div>
            </div>
          </div>
        )}

        {view === "form" && (
          <div className="max-w-xl mx-auto px-4 py-4 space-y-4">
            <div className="card p-5 border-slate-200 space-y-4">
              {/* Data + frecce */}
              <div className="flex flex-col items-center">
                <div className="flex items-center gap-2">
                  <button className="btn btn-ghost" onClick={() => { setGiorno((d) => addDaysISO(d, -1)); bumpIdle(); }}>←</button>
                  <button
                    type="button"
                    className="tag text-base px-3 py-2"
                    onClick={() => {
                      // @ts-ignore
                      if (dateInputRef.current?.showPicker) dateInputRef.current.showPicker();
                      else dateInputRef.current?.click();
                      bumpIdle();
                    }}
                  >
                    {fmtHumanDate(giorno)}
                  </button>
                  <button className="btn btn-ghost" onClick={() => { setGiorno((d) => addDaysISO(d, +1)); bumpIdle(); }}>→</button>
                  <input
                    ref={dateInputRef}
                    type="date"
                    className="sr-only"
                    value={giorno}
                    onChange={(e) => { setGiorno(e.target.value); bumpIdle(); }}
                  />
                </div>
              </div>

              {/* Sala */}
              <div>
                <label className="block text-sm text-slate-700 mb-1">Sala</label>
                <select className="select h-11" value={sala} onChange={(e) => { setSala(e.target.value); bumpIdle(); }}>
                  {SALE.map((s) => <option key={s}>{s}</option>)}
                </select>
                {prefs.last_sala && (
                  <div className="text-xs text-slate-500 mt-1">
                    Ultima sala usata: <b>{prefs.last_sala}</b>
                  </div>
                )}
              </div>

              {/* Orari rapidi */}
              <div>
                <div className="text-sm text-slate-700 mb-1">Orari</div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-xs text-slate-600 mb-1">Dalle</label>
                    <input type="time" step={1800} value={dalle} onChange={(e) => { setDalle(e.target.value); bumpIdle(); }} className="input h-11" />
                  </div>
                  <div>
                    <label className="block text-xs text-slate-600 mb-1">Alle</label>
                    <input type="time" step={1800} value={alle} onChange={(e) => { setAlle(e.target.value); bumpIdle(); }} className="input h-11" />
                  </div>
                </div>
                <div className="flex flex-wrap gap-2 mt-2">
                  <button className="btn btn-ghost btn-xs" onClick={() => { const n = nowHM(); setDalle(n); setAlle(plusMinutes(n, 60)); bumpIdle(); }}>Adesso</button>
                  <button className="btn btn-ghost btn-xs" onClick={() => { setAlle(plusMinutes(dalle, 30)); bumpIdle(); }}>+30m</button>
                  <button className="btn btn-ghost btn-xs" onClick={() => { setAlle(plusMinutes(dalle, 60)); bumpIdle(); }}>+1h</button>
                  <button className="btn btn-ghost btn-xs" onClick={() => { setAlle(plusMinutes(dalle, 90)); bumpIdle(); }}>+1h30</button>
                  <button className="btn btn-ghost btn-xs" onClick={() => { setAlle(plusMinutes(dalle, 60)); bumpIdle(); }}>60’</button>
                  <button className="btn btn-ghost btn-xs" onClick={() => { setAlle(plusMinutes(dalle, 90)); bumpIdle(); }}>90’</button>
                  <button className="btn btn-ghost btn-xs" onClick={() => { setAlle(plusMinutes(dalle, 120)); bumpIdle(); }}>120’</button>
                </div>
              </div>

              {/* Corso + suggerimenti */}
              <div>
                <label className="block text-sm text-slate-700 mb-1">Corso</label>
                <input className="input h-11" value={corso} onChange={(e) => { setCorso(e.target.value); bumpIdle(); }} placeholder="Es. Zumba" />
                {prefs.recent_corsi && prefs.recent_corsi.length > 0 && (
                  <div className="flex flex-wrap gap-2 mt-2">
                    {prefs.recent_corsi.map((c) => (
                      <button
                        key={c}
                        className="tag"
                        onClick={() => { setCorso(c); bumpIdle(); }}
                        type="button"
                        title="Usa questo corso"
                      >
                        {c}
                      </button>
                    ))}
                  </div>
                )}
              </div>

              {/* Sostituzione + Note */}
              <div className="flex items-center gap-2">
                <input id="sost" type="checkbox" className="check-lg" checked={sostituzione} onChange={(e) => { setSostituzione(e.target.checked); bumpIdle(); }} />
                <label htmlFor="sost" className="text-sm">Sostituzione</label>
              </div>
              <div>
                <label className="block text-sm text-slate-700 mb-1">Note</label>
                <textarea className="input h-24" value={note} onChange={(e) => { setNote(e.target.value); bumpIdle(); }} />
              </div>

              {/* Azioni */}
              <div className="flex items-center justify-between">
                <button className="btn btn-ghost" onClick={resetToList}>
                  Logout
                </button>
                <button className="btn btn-brand" onClick={() => { submit(); bumpIdle(); }}>
                  Salva
                </button>
              </div>
            </div>
          </div>
        )}
      </main>

      <footer className="py-6 text-center text-xs text-slate-500">
        © 2025 <span className="font-medium">Progettato da Roberto Tavano</span>
      </footer>
    </div>
  );
}